digraph G {
fontname = "Bitstream Vera Sans"
fontsize = 8

node [
fontname = "Bitstream Vera Sans"
fontsize = 8
shape = "record"
]

subgraph clusterRessources1 {
label = "Diagram Ressources.dot.png"

// Class Ressource
Ressource [
label = "{\
Ressource|\
- _entityFactory : EntityFactory &\l\
- _objectFactory : ItemFactory &\l\
- _entities : vector\<IEntity *\>\l\
- _objects : vector\<IItems *\>\l\
- _maps : vector\<Map *\>\l\
- _players : vector\<Player *\>\l|\
+ loadMaps(mapScript : fstream) : void\l\
}"

]

}

subgraph clusterRessources2 {
label = "Diagram Ressources.dot.png"

// Class Ressource
AEntity [
label = "{\
\<abstract\> - AEntity|\
- _id : unsigned int\l\
- _posX : unsigned int\l\
- _posY : unsigned int\l\
- _typeId : unsigned int\l\
- _skinId : unsigned int\l\
- _pv : int\l\
- _spawnFrameNum : unsigned int\l\
- _pf : PacketFactory &\l\
+ requests : list\<Packet *\>\l\
+ mutexRequests : AbsMutex\l\
}"
]

}

// Class Party
Party [
label = "{\
Party|\
+ _serverActions : map\<PacketCode, PartyActionFunc\>\l\
+ _mutexServerActions : AbsMutex\l\
- _actions : map\<PacketCode, PartyActionFunc\>\l\
- _UDPServer : UDP\l\
- _ressources : Ressource\l\
- _players : map\<Player &, Client &\>\l\
- _pf : PacketFactory &\l\
- _pe : PhysicEngine\l\
- _startTime : Timestamp\l\
- _entities : list\<pair\<IEntity *, AbsThread *\>\>\l|\
- playerMove(pak : APacket const &) : APacket *\l\
- playerKill(pak : APacket const &) : APacket *\l\
- monsterSpawn(pak : APacket const &) : APacket *\l\
- readEntities() : void\l\
- checkCollision() : void\l\
}"
]

// Class PhysicEngine
PhysicEngine [
label = "{\
PhysicEngine|\
- _ressources : Ressources &\l\
- _startTime : Timestamp\l\
- _environmentCollisions : list\<IEntity *\>\l\
- _entityCollisions : list\<pair\<IEntity *, IEntity *\>\>\l\
- _objectCollisions : list\<pair\<Player &, IItem *\>\>\l|\
+ PhysicEngine(ressources : Ressource &, startTime : Timestamp)\l\
+ checkCollision() : bool\l\
+ getEnvironmentCollisions() : list\<IEntity *\> &\l\
+ getEntityCollisions() : list\<pair\<IEntity *, IEntity *\>\> &\l\
+ getObjectCollisions() : list\<pair\<Player &, IItem *\>\> &\l\
- getCamera() : void\l\
}"
]

// Class Server
Server [
label = "{\
Server|\
- _pf : PacketFactory &\l\
- _parties : map\<Party, AbsThread *\>\l\
- _clients : map\<Client, AbsThread *\>\l|\
- _actions : map\<PacketCode, ServerActionFunc\>\l\
- createParty(pak : APacket const &) : APacket *\l\
+ run() : void\l\
+ processData() : void\l\
+ accept() : bool\l\
}"
]

// Class Client
Client [
label = "{\
Client||\
+ run() : void\l\
}"
]

// Class PacketFactory
PacketFactory [
label = "{\
\<singleton\> - PacketFactory|\
- packets : map\<PaketCode, Packet\>\l|\
+ getInstance() : PacketFactory &\l\
+ getPacket(PacketCode) : IPacket &\l\
+ typeExists(PacketCode) : bool\l\
}"
]

//
// TCPSESSION SUBGRAPH
//
subgraph clusterTCPSession {
label = "Diagram Network.dot.png"

// Class TCPSession
TCPSession [
label = "{\
TCPSession|\
- _socket : int\l\
- _server : TCPServer&\l\
- _bufferSize : unsigned int\l\
- _broken : bool\l\
- _canRead : bool\l\
- _canWrite : bool\l\
- _incoming : list\<Data\>\l\
+ outgoing : list\<Data\>\l\
+ mutexOutgoing : AbsMutex\l|\
+ TCPSession(socket : int, server : TCPServer&, bufferSize : unsigned int)\l\
+ virtual run() : void\l\
+ poll() : bool\l\
+ write(Data, unsigned int) : int\l\
+ read(Data, unsigned int) : int\l\
+ close() : bool\l\
}"
]

} // END : TCPSESSION SUBGRAPH

//
// UDP SUBGRAPH
//
subgraph clusterUDP {
label = "Diagram Network.dot.png"

// Class UDP
UDP [
label = "{\
UDP|\
- _socket : int\l|\
+ send(Data, unsigned int) : int\l\
+ receive(unsigned int) : int\l\
+ close() : void\l\
}"
]

} // END : UDP SUBGRAPH

//
// TCPSERVER SUBGRAPH
//
subgraph clusterTCPServer {
label = "Diagram Network.dot.png"

// Class TCPServer
TCPServer [
label = "{\
TCPServer|\
- _port : short\l\
- _socket : int\l\
- _bufferSize : unsigned int\l\
- _running : bool\l\
- _sessions : map\<ITCPSession*, AbsThread*\>\l\
+ requests : list\<pair\<ITCPSession*, Data\>\>\l\
+ mutexRequests : AbsMutex\l|\
+ TCPServer(port : short, bufferSize : unsigned int)\l\
+ init() : bool\l\
+ virtual run() : void\l\
+ virtual processData() : void\l\
+ close() : void\l\
+ virtual accept() : bool\l\
}"
]

} // END : TCPSERVER SUBGRAPH


//
// THREAD SUBGRAPH
//
subgraph clusterThread {
label = "Diagram ThreadMutex.dot.png"

// Concrete thread class for unix
AbsThread [
label = "{\
AbsThread|\
- _tid : pthread_t*\l|\
+ launch(startRoutine, void* args) : bool\l\
+ join() : bool\l\
+ exit() : void\l\
}"
]

} // END : THREAD SUBGRAPH

//
// MUTEX SUBGRAPH
//
subgraph clusterMutex {
label = "Diagram ThreadMutex.dot.png"

// Class AbsMutex
AbsMutex [
label = "{\
AbsMutex|\
- _mid : pthread_mutex_t*\l|\
+ init() : bool\l\
+ destroy() : void\l\
+ lock() : bool\l\
+ tryLock() : bool\l\
+ unlock() : bool\l\
}"
]

} // END : MUTEX SUBGRAPH

//
// APACKET SUBGRAPH
//
subgraph clusterAPacket {
label = "Diagram Packet.dot.png"

APacket [
label = "{\
\<abstract\> - APacket||\
+ header : PacketHeader\l\
+ data : AData\l\
}"
]

}

edge [
fontname = "Bitstream Vera Sans"
fontsize = 8
]

// Composition
AbsMutex -> TCPServer [arrowhead = "diamond" style = "solid"]
AbsMutex -> TCPSession [arrowhead = "diamond" style = "solid"]
AbsThread -> Party [arrowhead = "diamond" style = "solid"]
AbsMutex -> AEntity [arrowhead = "diamond" style = "solid"]
AbsThread -> TCPServer [arrowhead = "diamond" style = "solid"]
UDP -> Party [arrowhead = "diamond" style = "solid"]
Ressource -> Party [arrowhead = "diamond" style = "solid"]
PacketFactory -> Server [arrowhead = "diamond" style = "solid"]
PacketFactory -> Party [arrowhead = "diamond" style = "solid"]
PhysicEngine -> Party [arrowhead = "diamond" style = "solid"]
Ressource -> PhysicEngine [arrowhead = "diamond" style = "solid"]
PacketFactory -> AEntity [arrowhead = "diamond" style = "solid"]

// Aggregation
TCPSession -> TCPServer [arrowhead = "odiamond" style = "solid"]
Client -> Server [arrowhead = "odiamond" style = "solid"]
Client -> Party [arrowhead = "odiamond" style = "solid"]
Party -> Server [arrowhead = "odiamond" style = "solid"]
APacket -> PacketFactory [arrowhead = "odiamond" style = "solid"]

// Heritage
Server -> TCPServer [arrowhead = "onormal" style = "solid"]
Client -> TCPSession [arrowhead = "onormal" style = "solid"]

}
